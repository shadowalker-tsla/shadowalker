<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Shadowalker - Model Y Mileage</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
    button { background: #cc0000; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #a80000; }
    #mileage { font-weight: bold; font-size: 1.5em; }
  </style>
</head>
<body>
  <h1>The Shadowalker</h1>
  <p>Welcome to my personal site â€” tracking my Tesla Model Y mileage live via the Fleet API.</p>

  <h2>My Model Y Mileage</h2>
  <p>Current odometer reading: <span id="mileage">Loading...</span></p>
  <button onclick="connectTesla()">Connect / Reconnect Tesla</button>

  <script>
    function connectTesla() {
      const authUrl = `https://auth.tesla.com/oauth2/v3/authorize?` +
        `client_id=0ab7596a-006e-48d4-9b04-b165eb1ff29f&` +
        `redirect_uri=https://tesla-callback.theshadowalker.com/tesla-callback&` +
        `response_type=code&scope=vehicle_device_data%20offline_access&state=test123`;
      window.location.href = authUrl;
    }

    window.addEventListener('load', () => {
      if (window.location.hash) {
        const params = new URLSearchParams(window.location.hash.slice(1));
        const access = params.get('access_token');
        if (access) {
          localStorage.setItem('tesla_access_token', access);
          localStorage.setItem('tesla_refresh_token', params.get('refresh_token'));
          localStorage.setItem('tesla_token_expires', Date.now() + parseInt(params.get('expires_in') || 28800) * 1000);
          history.replaceState(null, null, window.location.pathname);
          fetchMileage();
        }
      }
      if (localStorage.getItem('tesla_access_token')) fetchMileage();
    });

    async function fetchMileage() {
      let token = localStorage.getItem('tesla_access_token');
      const el = document.getElementById('mileage');

      if (!token) {
        el.textContent = 'Not connected';
        return;
      }

      try {
        el.textContent = 'Fetching...';

        const vehiclesRes = await fetch('https://tesla-callback.theshadowalker.com/api/tesla/vehicles', {
          headers: { 'x-access-token': token }
        });

        if (!vehiclesRes.ok) throw new Error(`API error: ${vehiclesRes.status}`);

        const vehicles = await vehiclesRes.json();
        const vid = vehicles.response[0]?.id;
        if (!vid) throw new Error('No vehicle');

        const dataRes = await fetch(`https://tesla-callback.theshadowalker.com/api/tesla/vehicles/${vid}/vehicle_data`, {
          headers: { 'x-access-token': token }
        });

        if (!dataRes.ok) throw new Error(`Data error: ${dataRes.status}`);

        const data = await dataRes.json();
        const miles = data.response.vehicle_state.odometer;

        el.textContent = `${miles.toFixed(1)} miles`;
      } catch (err) {
        console.error('Fetch error:', err);
        el.textContent = 'Error loading mileage';
      }
    }
  </script>
</body>
</html>